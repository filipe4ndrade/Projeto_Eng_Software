<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('partials/header') %>
    <title>Avalia√ß√£o COVID-19 - <%= patient.name %></title>
</head>
<body>
    <div class="container">
        <div class="nav-actions">
            <a href="/patients" class="nav-link">‚Üê Voltar para a Lista</a>
        </div>

        <h1>Avalia√ß√£o de Risco COVID-19</h1>

        <div class="card">
            <h2>Informa√ß√µes do Paciente</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #007bff;">
                    <strong>Nome:</strong><br><%= patient.name %>
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #6c757d;">
                    <strong>ID:</strong><br><%= patient.id %>
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #28a745;">
                    <strong>Idade:</strong><br><%= patient.age %> anos
                </div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #ffc107;">
                    <strong>G√™nero:</strong><br><%= patient.gender === 'M' ? 'Masculino' : patient.gender === 'F' ? 'Feminino' : 'Outro' %>
                </div>
            </div>
        </div>

        <div class="result-box">
            <h2>Risco Estimado de COVID-19</h2>
            <p class="risk-value">
                <% 
                    let riskClass = 'risk-low';
                    if (risk > 15) riskClass = 'risk-high';
                    else if (risk > 8) riskClass = 'risk-medium';
                %>
                <span class="<%= riskClass %>">
                    <%= risk %>%
                </span>
            </p>
            <p style="color: #6c757d; font-size: 1.1rem;">
                <strong>Preval√™ncia na popula√ß√£o:</strong> 5.00%
            </p>
            <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <small>
                    <strong>Interpreta√ß√£o:</strong>
                    <% if (risk <= 8) { %>
                        <span style="color: #28a745; font-weight: bold;">Risco Baixo</span> - Probabilidade baixa de infec√ß√£o por COVID-19.
                    <% } else if (risk <= 15) { %>
                        <span style="color: #ffc107; font-weight: bold;">Risco Moderado</span> - Recomenda-se teste diagn√≥stico.
                    <% } else if (risk <= 30) { %>
                        <span style="color: #fd7e14; font-weight: bold;">Risco Alto</span> - Teste urgente e isolamento recomendados.
                    <% } else { %>
                        <span style="color: #dc3545; font-weight: bold;">Risco Muito Alto</span> - Buscar atendimento m√©dico imediato.
                    <% } %>
                </small>
            </div>
        </div>

        <div class="card">
            <h2>ÔøΩ Sintomas e Fatores de Risco COVID-19</h2>
            <div class="factors-list">
                <% 
                // Garantir que factors seja um array
                const patientFactors = Array.isArray(patient.factors) ? patient.factors : [];
                %>
                <% if (patientFactors.length > 0) { %>
                    <h4 style="margin-bottom: 15px; color: #e74c3c;">üö® Sintomas/Fatores Presentes:</h4>
                    <ul>
                        <% patientFactors.forEach(factor => { %>
                            <li style="margin-bottom: 10px;">
                                <strong>üî∏ <%= factor.replace(/_/g, ' ').toUpperCase() %></strong>
                                <% if (symptomInfo[factor]) { %>
                                    <br><small style="color: #7f8c8d; margin-left: 20px;">
                                        üìù <%= symptomInfo[factor].description %>
                                        <br><span style="color: #e74c3c; font-weight: bold;">
                                            üéØ <%= symptomInfo[factor].severity %>
                                        </span>
                                    </small>
                                <% } %>
                            </li>
                        <% }) %>
                    </ul>
                <% } else { %>
                    <div style="text-align: center; padding: 15px; background: #d4edda; border-radius: 4px; border: 1px solid #c3e6cb;">
                        <p style="color: #155724; font-weight: bold; margin: 0;">Nenhum sintoma identificado</p>
                    </div>
                <% } %>
            </div>
        </div>
        
        <div class="card">
            <h3>Atualizar Sintomas</h3>
            <form action="/patients/<%= patient.id %>/factors" method="POST">
                <p style="margin-bottom: 15px; color: #6c757d;">
                    Selecione os sintomas que o paciente apresenta atualmente:
                </p>
                
                <div class="factor-options">
                    <% availableFactors.forEach(factor => { %>
                        <% 
                        const isSelected = Array.isArray(patient.factors) && patient.factors.includes(factor);
                        const selectedClass = isSelected ? 'factor-selected' : '';
                        %>
                        <div class="<%= selectedClass %>">
                            <label style="display: flex; align-items: flex-start; cursor: pointer;">
                                <input 
                                    type="checkbox" 
                                    name="factors" 
                                    value="<%= factor %>" 
                                    <%= isSelected ? 'checked' : '' %>
                                    style="margin-top: 5px;"
                                >
                                <div style="margin-left: 12px; flex: 1;">
                                    <span style="font-weight: bold; color: #2c3e50;">
                                        <%= factor.replace(/_/g, ' ').toUpperCase() %>
                                    </span>
                                    <% if (symptomInfo[factor]) { %>
                                        <br><small style="color: #6c757d; margin-top: 3px; display: block;">
                                            <%= symptomInfo[factor].description %>
                                        </small>
                                    <% } %>
                                </div>
                            </label>
                        </div>
                    <% }) %>
                </div>
                
                <button type="submit" class="button-secondary">Atualizar Sintomas</button>
            </form>
        </div>

        <div class="card">
            <h2>ÔøΩ Resultado do Teste COVID-19 (Laborat√≥rio)</h2>
            <% 
            // Definir classes baseadas no resultado
            const resultClass = labResult.positive ? 'lab-result-positive' : 'lab-result-negative';
            const textClass = labResult.positive ? 'result-text-positive' : 'result-text-negative';
            %>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Tipo de Teste</h4>
                    <p style="font-size: 1.1rem;"><%= labResult.testType %></p>
                </div>
                <div class="<%= resultClass %>" style="padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Resultado</h4>
                    <p class="<%= textClass %>" style="font-size: 1.3rem; font-weight: bold;">
                        <%= labResult.positive ? 'POSITIVO' : 'NEGATIVO' %>
                    </p>
                    <small style="margin-top: 8px; display: block; color: #6c757d;">
                        <%= labResult.interpretation %>
                    </small>
                </div>
                <div style="background: #fff9e6; padding: 20px; border-radius: 10px; border-left: 4px solid #f39c12;">
                    <h4 style="margin-bottom: 10px; color: #2c3e50;">Confiabilidade</h4>
                    <p style="font-size: 1.2rem; font-weight: bold; color: #f39c12;">
                        <%= (labResult.confidence * 100).toFixed(1) %>%
                    </p>
                    <small style="color: #6c757d;">Precis√£o do teste</small>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #6c757d;">
                <h4 style="color: #495057; margin-bottom: 10px;">Recomenda√ß√µes</h4>
                <p style="color: #6c757d; margin-bottom: 0;">
                    <%= labResult.recommendations %>
                </p>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border-left: 4px solid #9b59b6;">
                <h4 style="color: #8e44ad; margin-bottom: 10px;">An√°lise Combinada</h4>
                <p style="color: #5a6c7d;">
                    <% if (labResult.positive && risk > 10) { %>
                        <strong>Alta correla√ß√£o:</strong> Tanto o c√°lculo quanto o exame indicam risco elevado.
                    <% } else if (!labResult.positive && risk <= 3) { %>
                        <strong>Baixa correla√ß√£o:</strong> Tanto o c√°lculo quanto o exame indicam risco baixo.
                    <% } else { %>
                        <strong>Resultados divergentes:</strong> O c√°lculo e o exame apresentam indica√ß√µes diferentes. Recomenda-se an√°lise m√©dica.
                    <% } %>
                </p>
            </div>
        </div>
    </div>
</body>
</html>